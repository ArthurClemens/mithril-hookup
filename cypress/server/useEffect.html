<html>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/mithril/mithril.js"></script>
  <script src="../../dist/mithril-hookup.js"></script>
  <script>
const hookup = mithrilHookup.hookup;

let renderRunCounts = {
  mountOnly: 0,
  onChange: 0,
  render: 0,
};

const RunCountOnMount = hookup((vnode, { useState, useEffect }) => {
  const [effectRunCount, setEffectRunCounts] = useState(0);

  renderRunCounts.mountOnly++;
  useEffect(
    () => {
      setEffectRunCounts(n => n + 1);
    },
    []
  );
  return m("[data-test-id=RunCountOnMount]", [
  m("h2", "RunCountOnMount"),
    m("p[data-test-id=effectRunCount]", 
      `effect called: ${effectRunCount}`
    ),
    m("p[data-test-id=renderRunCounts]", 
      `render called: ${renderRunCounts.mountOnly}`
    ),
    m("button[data-test-id=button]", 
      { onclick: () => {} },
      "Trigger render"
    ),
  ]);
});

const RunCountOnChange = hookup((vnode, { useState, useEffect }) => {
  const [effectRunCount, setEffectRunCounts] = useState(0);
  const [someValue, setSomeValue] = useState(0);

  renderRunCounts.onChange++;
  useEffect(
    () => {
      setEffectRunCounts(n => n + 1);
    },
    [someValue]
  );
  return m("[data-test-id=RunCountOnChange]", [
    m("h2", "RunCountOnChange"),
    m("p[data-test-id=effectRunCount]", 
      `effect called: ${effectRunCount}`
    ),
    m("p[data-test-id=renderRunCounts]", 
      `render called: ${renderRunCounts.onChange}`
    ),
    m("button[data-test-id=button]", 
      { onclick: () => setSomeValue(someValue + 1) },
      "Trigger render"
    ),
  ]);
});

const RunCountOnRender = hookup((vnode, { useState, useEffect }) => {
  const [effectRunCount, setEffectRunCounts] = useState(0);
  const [someValue, setSomeValue] = useState(0);

  renderRunCounts.render++;
  useEffect(
    () => {
      setEffectRunCounts(n => n + 1);
    },
    [someValue]
  );
  return m("[data-test-id=RunCountOnRender]", [
  m("h2", "RunCountOnRender"),
    m("p[data-test-id=effectRunCount]", 
      `effect called: ${effectRunCount}`
    ),
    m("p[data-test-id=renderRunCounts]", 
      `render called: ${renderRunCounts.render}`
    ),
    m("button[data-test-id=button]", 
      { onclick: () => setSomeValue(someValue + 1) },
      "Trigger render"
    ),
  ]);
});

const SideEffect = hookup((vnode, { useState, useEffect }) => {
  const [darkModeEnabled, setDarkModeEnabled] = useState(false);
  useEffect(
    () => {
      const className = "dark-mode";
      const element = document.querySelector("#root");
      if (darkModeEnabled) {
        element.classList.add(className);
      } else {
        element.classList.remove(className);
      }
    },
    [darkModeEnabled] // Only re-run when value has changed
  );
  return m("[data-test-id=dark]", [
    m("h2", "SideEffect"),
    m("p[data-test-id=darkModeEnabled]", 
      `SideEffect mode enabled: ${darkModeEnabled}`
    ),
    m("button[data-test-id=button]", 
      { onclick: () => setDarkModeEnabled(true) },
      "Set dark mode"
    ),
  ]);
});

const App = {
  view: () => [
    m(SideEffect),
    m(RunCountOnMount),
    m(RunCountOnChange),
    m(RunCountOnRender),
  ]
}

m.mount(
  document.querySelector("#root"),
  App
);

  </script>
</body>
</html>
